using Harmony12;
using Kingmaker;
using Kingmaker.Blueprints.Classes;
using Kingmaker.Blueprints.Classes.Spells;
using Kingmaker.Blueprints.Root;
using Kingmaker.EntitySystem.Entities;
using Kingmaker.GameModes;
using Kingmaker.UnitLogic;
using Kingmaker.UnitLogic.Abilities;
using Kingmaker.UnitLogic.Abilities.Blueprints;
using Kingmaker.UnitLogic.Commands;
using Kingmaker.Utility;
using Kingmaker.View;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text.RegularExpressions;
using UnityEngine;
using UnityModManagerNet;

namespace KingmakerBuffBot
{

    public class Settings : UnityModManager.ModSettings
    {
        public List<SpellProfile> spellProfiles = new List<SpellProfile>();
        public List<SpellInfo> readyForProfileSpells = new List<SpellInfo>();
        public override void Save(UnityModManager.ModEntry modEntry)
        {
            Save(this, modEntry);
        }

    }
    public class SpellProfile
    {
        public string ProfileID { get; set; }
        public string ProfileName { get; set; }
        public List<string> Spells { get; set; }
    }
    public class SpellInfo
    {
        public string Name { get; set; }
        public int SpellLevel { get; set; }
    }
    static class Main
    {
        public static Settings settings;
        public static int menu = 0;
        public static bool enabled;
        public static List<AbilityData> allKnownSpells = new List<AbilityData>();
        public static int allKnownSpellLevelMenu;
        public static int readyForProfileSpellLevelMenu;
        public static string createProfileName = "Profile";
        public static SpellProfile managedProfile = new SpellProfile();
        static bool Load(UnityModManager.ModEntry modEntry)
        {
            var harmony = HarmonyInstance.Create(modEntry.Info.Id);
            harmony.PatchAll(Assembly.GetExecutingAssembly());
            settings = Settings.Load<Settings>(modEntry);
            modEntry.OnToggle = OnToggle;
            modEntry.OnGUI = OnGUI;
            modEntry.OnSaveGUI = OnSaveGUI;
            return true;
        }

        public static void OnSaveGUI(UnityModManager.ModEntry modEntry)
        {
            settings.Save(modEntry);
        }

        static bool OnToggle(UnityModManager.ModEntry modEntry, bool value)
        {
            enabled = value;

            return true;
        }

        static void OnGUI(UnityModManager.ModEntry modEntry)
        {
            try
            {
                if (Game.Instance == null || Game.Instance.CurrentMode != GameModeType.Default
                && Game.Instance.CurrentMode != GameModeType.GlobalMap
                && Game.Instance.CurrentMode != GameModeType.FullScreenUi
                && Game.Instance.CurrentMode != GameModeType.Pause
                && Game.Instance.CurrentMode != GameModeType.EscMode
                && Game.Instance.CurrentMode != GameModeType.Rest
                && Game.Instance.CurrentMode != GameModeType.Kingdom)
                {
                    Helpers.Label("BuffBot cannot be used right now.");
                    return;
                }
                else
                {
                    CreateMainMenu();
                }
            }
            catch (Exception e)
            {
                modEntry.Logger.Error($"Error rendering GUI: {e}");
            }
        }

        private static void CreateMainMenu()
        {
            using (var verticalScope = new GUILayout.VerticalScope())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope("box"))
                {
                    if (GUILayout.Button("Execute Spells"))
                    {
                        menu = 0;
                    }
                    if (GUILayout.Button("Add Spells"))
                    {
                        menu = 2;
                    }
                    if (GUILayout.Button("Create/Remove Profiles"))
                    {
                        menu = 3;
                    }
                    if (GUILayout.Button("Spell/Profile Management"))
                    {
                        menu = 1;
                    }
                    if (GUILayout.Button("Manage Profile Details"))
                    {
                        menu = 4;
                    }
                }
                switch (menu)
                {
                    case 1:
                        SpellsManager();
                        break;
                    case 2:
                        SpellsManager();
                        break;
                    case 3:
                        ProfilesManager();
                        break;
                    case 4:
                        ProfilesManager();
                        break;
                    default:
                        //Helpers.Log("Execute Menu");
                        break;
                }
            }
        }

        private static void ProfilesManager()
        {
            using (var horizontalScope = new GUILayout.HorizontalScope("box"))
            {
                using (var verticalScope = new GUILayout.VerticalScope())
                {
                    switch (menu)
                    {
                        case 3:
                            CreateRemoveProfile();
                            break;
                        case 4:
                            ManageProfiles();
                            break;
                        default:
                            break;
                    }
                }
            }
        }

        private static void ManageProfiles()
        {
            using (var horizontalScope = new GUILayout.HorizontalScope("box"))
            {
            }
        }

        private static void CreateRemoveProfile()
        {
            using (var verticalScope = new GUILayout.VerticalScope())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope("box"))
                {
                    GUILayout.Label("Create a profile:", GUILayout.ExpandWidth(false));
                    createProfileName = GUILayout.TextField(createProfileName, 250);
                    if (!String.IsNullOrEmpty(createProfileName))
                    {
                        if (GUILayout.Button("Create"))
                        {
                            SpellProfile spellProfile = new SpellProfile();
                            spellProfile.ProfileID = Guid.NewGuid().ToString();
                            spellProfile.ProfileName = createProfileName;
                            spellProfile.Spells = new List<string>();
                            settings.spellProfiles.Add(spellProfile);
                            createProfileName = "";
                        }
                    }
                }
                foreach (var sp in settings.spellProfiles.ToList())
                {
                    using (var horizontalScope2 = new GUILayout.HorizontalScope("box"))
                    {
                        if (GUILayout.Button("X", GUILayout.ExpandWidth(false)))
                        {
                            settings.spellProfiles.Remove(sp);
                        }
                        if (sp != null)
                        {
                            Helpers.Label(sp.ProfileName);
                        }
                    }
                }
            }
        }


        private static void SpellsManager()
        {
            using (var horizontalScope = new GUILayout.HorizontalScope("box"))
            {
                using (var verticalScope = new GUILayout.VerticalScope())
                {
                    switch (menu)
                    {
                        case 1:
                            SetSpellLevelButtons();
                            ShowReadyForProfileSpells();
                            break;
                        case 2:
                            SetSpellLevelButtons();
                            ShowKnownSpells();
                            break;
                        default:
                            break;
                    }
                }
            }
        }

        private static void ShowKnownSpells()
        {
            foreach (var aks in allKnownSpells.Where(o => o.SpellLevel == allKnownSpellLevelMenu).ToList())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope())
                {
                    if (settings.readyForProfileSpells.FirstOrDefault(o => o.Name == aks.Name) == null)
                    {
                        if (GUILayout.Button(aks.Name))
                        {
                            SpellInfo rfps = new SpellInfo()
                            {
                                Name = aks.Name,
                                SpellLevel = aks.SpellLevel
                            };
                            settings.readyForProfileSpells.Add(rfps);
                        }
                    }
                }
            }
        }
        private static void ShowReadyForProfileSpells()
        {
            foreach (var rfps in settings.readyForProfileSpells.Where(o => o.SpellLevel == readyForProfileSpellLevelMenu).ToList())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope())
                {
                    if (GUILayout.Button("X", GUILayout.Width(25)))
                    {
                        foreach (var sp in settings.spellProfiles.ToList())
                        {
                            foreach (var s in sp.Spells.Where(o => o.Contains(rfps.Name)).ToList())
                            {
                                sp.Spells.Remove(s);
                            }
                        }
                        settings.readyForProfileSpells.Remove(rfps);
                    }
                    if (rfps != null)
                    {
                        GUILayout.Label(rfps.Name, GUILayout.Width(150));
                        using (var verticalScope = new GUILayout.VerticalScope())
                        {
                            var amountPerRow = 6;
                            for (var i = 0; i <= Math.Round(settings.spellProfiles.Count / (double)amountPerRow) * amountPerRow; i += amountPerRow)
                            {
                                using (var horizontalScope2 = new GUILayout.HorizontalScope())
                                {
                                    foreach (var sp in settings.spellProfiles.ToList().Skip(i).Take(amountPerRow))
                                    {
                                        if (sp.Spells.Contains(rfps.Name))
                                        {
                                            if (GUILayout.Button("-", GUILayout.Width(25)))
                                            {
                                                sp.Spells.Remove(rfps.Name);
                                            }
                                        }
                                        else
                                        {
                                            if (GUILayout.Button("+", GUILayout.Width(25)))
                                            {
                                                sp.Spells.Add(rfps.Name);
                                            }
                                        }
                                        GUILayout.Label(sp.ProfileName, GUILayout.Width(50));
                                        GUILayout.Label("|", GUILayout.Width(25));
                                    }
                                    for (var i2 = 0; i2 < (amountPerRow - settings.spellProfiles.ToList().Skip(i).Take(amountPerRow).Count()); i2++)
                                    {
                                        GUILayout.Label("", GUILayout.Width(25));
                                        GUILayout.Label("", GUILayout.Width(50));
                                        GUILayout.Label("|", GUILayout.Width(25));
                                    }
                                }
                            }
                        }

                    }
                }
                GUILayout.Label("", GUI.skin.horizontalSlider);
            }
        }

        private static void SetSpellLevelButtons()
        {
            using (var verticalScope = new GUILayout.VerticalScope())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope("box"))
                {
                    Helpers.Label("Spell Level:");
                    for (var i = 0; i < 10; i++)
                    {
                        if (menu == 2)
                        {
                            if (GUILayout.Button(i.ToString()))
                            {
                                PopulateAllKnownSpells();
                                allKnownSpellLevelMenu = i;
                            }
                        }
                        else
                        {
                            if (GUILayout.Button(i.ToString()))
                            {
                                readyForProfileSpellLevelMenu = i;
                            }
                        }
                    }
                }
            }
        }

        private static void PopulateAllKnownSpells()
        {
            foreach (var ac in Game.Instance.Player.AllCharacters.ToList())
            {
                foreach (var sb in ac.Descriptor.Spellbooks.ToList())
                {
                    foreach (var s in sb.GetAllKnownSpells().ToList())
                    {
                        if (allKnownSpells.FirstOrDefault(o => o.Name == s.Name) == null)
                        {
                            allKnownSpells.Add(s);
                        }
                    }
                }
            }
        }
    }
}