using Harmony12;
using Kingmaker;
using Kingmaker.Blueprints.Classes;
using Kingmaker.Blueprints.Classes.Spells;
using Kingmaker.Blueprints.Root;
using Kingmaker.EntitySystem.Entities;
using Kingmaker.GameModes;
using Kingmaker.UnitLogic;
using Kingmaker.UnitLogic.Abilities;
using Kingmaker.UnitLogic.Abilities.Blueprints;
using Kingmaker.UnitLogic.Commands;
using Kingmaker.Utility;
using Kingmaker.View;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text.RegularExpressions;
using UnityEngine;
using UnityModManagerNet;

namespace KingmakerBuffBot
{

    public class Settings : UnityModManager.ModSettings
    {
        public List<SpellProfile> spellProfiles = new List<SpellProfile>();
        public List<SpellInfo> readyForProfileSpells = new List<SpellInfo>();
        public List<SlotAssignment> slotAssignments = new List<SlotAssignment>();
        public override void Save(UnityModManager.ModEntry modEntry)
        {
            Save(this, modEntry);
        }
    }
    public class SlotAssignment
    {
        public int SlotIndex { get; set; }
        public string SpellProfileId { get; set; }
        public int CastingOrder { get; set; }
    }
    public class SpellProfile
    {
        public string ProfileID { get; set; }
        public string ProfileName { get; set; }
        public List<SpellInfo> Spells { get; set; }
    }
    public class SpellInfo
    {
        public string Name { get; set; }
        public int SpellLevel { get; set; }
        public List<string> Metamagics { get; set; }
    }
    static class Main
    {
        public static Settings settings;
        public static int menu = 0;
        public static bool enabled;
        public static List<AbilityData> allKnownSpells = new List<AbilityData>();
        public static int allKnownSpellLevelMenu;
        public static int readyForProfileSpellLevelMenu;
        public static string createProfileName = "Profile";
        public static SpellProfile managedProfile = new SpellProfile();
        public static List<UnitAssignment> unitAssignments = new List<UnitAssignment>();
        
        public class UnitAssignment
        {
            public int SlotIndex { get; set; }
            public UnitEntityData Unit { get; set; }
        }
        static bool Load(UnityModManager.ModEntry modEntry)
        {
            var harmony = HarmonyInstance.Create(modEntry.Info.Id);
            harmony.PatchAll(Assembly.GetExecutingAssembly());
            settings = Settings.Load<Settings>(modEntry);
            modEntry.OnToggle = OnToggle;
            modEntry.OnGUI = OnGUI;
            modEntry.OnSaveGUI = OnSaveGUI;
            return true;
        }

        public static void OnSaveGUI(UnityModManager.ModEntry modEntry)
        {
            settings.Save(modEntry);
        }

        static bool OnToggle(UnityModManager.ModEntry modEntry, bool value)
        {
            enabled = value;

            return true;
        }

        static void OnGUI(UnityModManager.ModEntry modEntry)
        {
            try
            {
                if (Game.Instance == null || Game.Instance.CurrentMode != GameModeType.Default
                && Game.Instance.CurrentMode != GameModeType.GlobalMap
                && Game.Instance.CurrentMode != GameModeType.FullScreenUi
                && Game.Instance.CurrentMode != GameModeType.Pause
                && Game.Instance.CurrentMode != GameModeType.EscMode
                && Game.Instance.CurrentMode != GameModeType.Rest
                && Game.Instance.CurrentMode != GameModeType.Kingdom)
                {
                    Helpers.Label("BuffBot cannot be used right now.");
                    return;
                }
                else
                {
                    CreateMainMenu();
                }
            }
            catch (Exception e)
            {
                modEntry.Logger.Error($"Error rendering GUI: {e}");
            }
        }

        private static void CreateMainMenu()
        {
            using (var verticalScope = new GUILayout.VerticalScope())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope("box"))
                {
                    if (GUILayout.Button("Execute Spells"))
                    {
                        menu = 0;
                    }
                    if (GUILayout.Button("Attach Profiles"))
                    {
                        menu = 5;
                    }
                    if (GUILayout.Button("Add Spells"))
                    {
                        menu = 2;
                    }
                    if (GUILayout.Button("Create/Remove Profiles"))
                    {
                        menu = 3;
                    }
                    if (GUILayout.Button("Spell/Profile Management"))
                    {
                        menu = 1;
                    }
                    if (GUILayout.Button("Manage Metamagics"))
                    {
                        menu = 4;
                    }
                }
                switch (menu)
                {
                    case 1:
                        SpellsManager();
                        break;
                    case 2:
                        SpellsManager();
                        break;
                    case 3:
                        ProfilesManager();
                        break;
                    case 4:
                        ProfilesManager();
                        break;
                    case 5:
                        AttachProfilesManager();
                        break;
                    default:
                        ExecutionQueue();
                        break;
                }
            }
        }

        private static void ExecutionQueue()
        {
            throw new NotImplementedException();
        }
        private static void AttachProfilesManager()
        {
            FindPartyAssignment();
            AttachProfiles();
        }

        private static void FindPartyAssignment()
        {
            int i = 1;
            List<UnitAssignment> unitAssignmentsTemp = new List<UnitAssignment>();
            foreach(var u in Game.Instance.Player.PartyCharacters.ToList())
            {
                UnitDescriptor uD = u.Value.Descriptor;
                UnitAssignment uA = new UnitAssignment
                {
                    SlotIndex = i,
                    Unit = uD.Unit
                };
                unitAssignmentsTemp.Add(uA);
                i++;
                if (uD.Pet != null)
                {
                    if (uD.Pet.IsInState)
                    {
                        UnitAssignment uAPet = new UnitAssignment
                        {
                            SlotIndex = i,
                            Unit = uD.Pet
                        };
                        unitAssignmentsTemp.Add(uAPet);
                        i++;
                    }
                }
            }
            unitAssignments = unitAssignmentsTemp;
        }

        private static void AttachProfiles()
        {
            List<UnitReference> partyRefs = Game.Instance.Player.PartyCharacters;

            if (settings.slotAssignments.Count == 0)
            {
                for (int i = 1; i < 13; i++)
                {
                    SlotAssignment sa = new SlotAssignment();
                    SpellProfile sp = new SpellProfile();
                    sa.SlotIndex = i;
                    sa.SpellProfileId = sp.ProfileID;
                    sa.CastingOrder = i;
                    settings.slotAssignments.Add(sa);
                }
            }
            using (var verticalScope = new GUILayout.VerticalScope())
            {
                foreach (var sa in settings.slotAssignments.ToList())
                {
                    using (var horizontalScope = new GUILayout.HorizontalScope())
                    {
                        string characterInSlot = "";
                        if(unitAssignments.FirstOrDefault(o => o.SlotIndex == sa.SlotIndex) != null)
                        {
                            characterInSlot = unitAssignments.FirstOrDefault(o => o.SlotIndex == sa.SlotIndex).Unit.CharacterName;
                            Helpers.Log(characterInSlot);
                        }
                        GUILayout.Label("Slot " + sa.SlotIndex + ": "+ characterInSlot, GUILayout.Width(150));
                        GUILayout.Label("Casting Order: " + sa.CastingOrder + " ", GUILayout.Width(150));
                        sa.CastingOrder = Mathf.RoundToInt(GUILayout.HorizontalSlider(sa.CastingOrder, 1.0f, 12.0f,GUILayout.Width(200)));
                        if (settings.slotAssignments.FirstOrDefault(o => (o.CastingOrder == sa.CastingOrder) && (o.SlotIndex != sa.SlotIndex)) != null)
                        {
                            List<int> currentNum = new List<int>();
                            foreach (var s in settings.slotAssignments.ToList())
                            {
                                currentNum.Add(s.CastingOrder);
                            }
                            var result = Enumerable.Range(1, 12).Except(currentNum).ToList();
                            if (result.Count > 0)
                            {
                                settings.slotAssignments.FirstOrDefault(o => (o.CastingOrder == sa.CastingOrder) && (o.SlotIndex != sa.SlotIndex)).CastingOrder = result.FirstOrDefault();
                            }
                        }
                        GUILayout.Label("Current Profile: ", GUILayout.Width(75));
                        if (settings.spellProfiles.Count == 0)
                        {
                            GUILayout.Label("No profiles!");
                        }
                        else
                        {
                            int spIndex = 0;
                            if (settings.spellProfiles.FirstOrDefault(o => o.ProfileID == sa.SpellProfileId) != null)
                            {
                                spIndex = settings.spellProfiles.FindIndex(o => o.ProfileID == sa.SpellProfileId);
                            }
                            float f = settings.spellProfiles.Count - 1;
                            spIndex = Mathf.RoundToInt(GUILayout.HorizontalSlider(spIndex, 0.0f, f, GUILayout.Width(200)));
                            sa.SpellProfileId = settings.spellProfiles.ElementAtOrDefault(spIndex).ProfileID;
                            GUILayout.Label(settings.spellProfiles.FirstOrDefault(o => o.ProfileID == sa.SpellProfileId).ProfileName);
                        }
                    }
                }
            }

        }

        private static void ProfilesManager()
        {
            using (var horizontalScope = new GUILayout.HorizontalScope("box"))
            {
                using (var verticalScope = new GUILayout.VerticalScope())
                {
                    switch (menu)
                    {
                        case 3:
                            CreateRemoveProfile();
                            break;
                        case 4:
                            ManageMetamagics();
                            break;
                        default:
                            break;
                    }
                }
            }
        }

        private static void ManageMetamagics()
        {
            using (var verticalScope = new GUILayout.VerticalScope("box"))
            {
                foreach (var sp in settings.spellProfiles.ToList())
                {
                    using (var horizontalScope = new GUILayout.HorizontalScope())
                    {
                        GUILayout.Label(sp.ProfileName, GUILayout.Width(150));
                        using (var verticalScope2 = new GUILayout.VerticalScope())
                        {
                            foreach (var s in sp.Spells.ToList())
                            {
                                GUILayout.Label(s.Name, GUILayout.Width(150));
                                using (var horizontalScope2 = new GUILayout.HorizontalScope())
                                {
                                    foreach (var m in Enum.GetNames(typeof(Metamagic)).ToList())
                                    {
                                        if(s.Metamagics == null)
                                        {
                                            s.Metamagics = new List<string>();
                                        }
                                        if (!s.Metamagics.Contains(m))
                                        {
                                            if (GUILayout.Button("+", GUILayout.Width(25)))
                                            {
                                                s.Metamagics.Add(m);
                                            }
                                            GUILayout.Label(m, GUILayout.Width(75));
                                        }
                                        else
                                        {
                                            if (GUILayout.Button("-", GUILayout.Width(25)))
                                            {
                                                s.Metamagics.Remove(m);
                                            }
                                            GUILayout.Label(m, GUILayout.Width(75));
                                        }
                                    }
                                }
                            }
                        }
                    }
                    GUILayout.Label("", GUI.skin.horizontalSlider);
                }
            }
        }

        private static void CreateRemoveProfile()
        {
            using (var verticalScope = new GUILayout.VerticalScope())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope("box"))
                {
                    GUILayout.Label("Create a profile:", GUILayout.ExpandWidth(false));
                    createProfileName = GUILayout.TextField(createProfileName, 250);
                    if (!String.IsNullOrEmpty(createProfileName))
                    {
                        if (GUILayout.Button("Create"))
                        {
                            SpellProfile spellProfile = new SpellProfile();
                            spellProfile.ProfileID = Guid.NewGuid().ToString();
                            spellProfile.ProfileName = createProfileName;
                            spellProfile.Spells = new List<SpellInfo>();
                            settings.spellProfiles.Add(spellProfile);
                            createProfileName = "";
                        }
                    }
                }
                foreach (var sp in settings.spellProfiles.ToList())
                {
                    using (var horizontalScope2 = new GUILayout.HorizontalScope("box"))
                    {
                        if (GUILayout.Button("X", GUILayout.ExpandWidth(false)))
                        {
                            foreach (var sa in settings.slotAssignments.Where(o => o.SpellProfileId == sp.ProfileID).ToList())
                            {
                                sa.SpellProfileId = "";
                            };
                            settings.spellProfiles.Remove(sp);
                        }
                        if (sp != null)
                        {
                            Helpers.Label(sp.ProfileName);
                        }
                    }
                }
            }
        }


        private static void SpellsManager()
        {
            using (var horizontalScope = new GUILayout.HorizontalScope("box"))
            {
                using (var verticalScope = new GUILayout.VerticalScope())
                {
                    switch (menu)
                    {
                        case 1:
                            SetSpellLevelButtons();
                            ShowReadyForProfileSpells();
                            break;
                        case 2:
                            SetSpellLevelButtons();
                            ShowKnownSpells();
                            break;
                        default:
                            break;
                    }
                }
            }
        }

        private static void ShowKnownSpells()
        {
            foreach (var aks in allKnownSpells.Where(o => o.SpellLevel == allKnownSpellLevelMenu).ToList())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope())
                {
                    if (settings.readyForProfileSpells.FirstOrDefault(o => o.Name == aks.Name) == null)
                    {
                        if (GUILayout.Button(aks.Name))
                        {
                            SpellInfo rfps = new SpellInfo()
                            {
                                Name = aks.Name,
                                SpellLevel = aks.SpellLevel,
                                Metamagics = new List<string>()
                            };
                            settings.readyForProfileSpells.Add(rfps);
                        }
                    }
                }
            }
        }
        private static void ShowReadyForProfileSpells()
        {
            foreach (var rfps in settings.readyForProfileSpells.Where(o => o.SpellLevel == readyForProfileSpellLevelMenu).ToList())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope())
                {
                    if (GUILayout.Button("X", GUILayout.Width(25)))
                    {
                        foreach (var sp in settings.spellProfiles.ToList())
                        {
                            foreach (var s in sp.Spells.Where(o => o.Name.Contains(rfps.Name)).ToList())
                            {
                                sp.Spells.Remove(s);
                            }
                        }
                        settings.readyForProfileSpells.Remove(rfps);
                    }
                    if (rfps != null)
                    {
                        GUILayout.Label(rfps.Name, GUILayout.Width(150));
                        using (var verticalScope = new GUILayout.VerticalScope())
                        {
                            var amountPerRow = 6;
                            for (var i = 0; i <= Math.Round(settings.spellProfiles.Count / (double)amountPerRow) * amountPerRow; i += amountPerRow)
                            {
                                using (var horizontalScope2 = new GUILayout.HorizontalScope())
                                {
                                    foreach (var sp in settings.spellProfiles.Skip(i).Take(amountPerRow).ToList())
                                    {
                                        if (sp.Spells.FirstOrDefault(o => o.Name == rfps.Name) != null)
                                        {
                                            if (GUILayout.Button("-", GUILayout.Width(25)))
                                            {
                                                sp.Spells.Remove(sp.Spells.FirstOrDefault(o => o.Name == rfps.Name));
                                            }
                                        }
                                        else
                                        {
                                            if (GUILayout.Button("+", GUILayout.Width(25)))
                                            {
                                                sp.Spells.Add(rfps);
                                            }
                                        }
                                        GUILayout.Label(sp.ProfileName, GUILayout.Width(50));
                                        GUILayout.Label("|", GUILayout.Width(25));
                                    }
                                    for (var i2 = 0; i2 < (amountPerRow - settings.spellProfiles.ToList().Skip(i).Take(amountPerRow).Count()); i2++)
                                    {
                                        GUILayout.Label("", GUILayout.Width(25));
                                        GUILayout.Label("", GUILayout.Width(50));
                                        GUILayout.Label("|", GUILayout.Width(25));
                                    }
                                }
                            }
                        }

                    }
                }
                GUILayout.Label("", GUI.skin.horizontalSlider);
            }
        }

        private static void SetSpellLevelButtons()
        {
            using (var verticalScope = new GUILayout.VerticalScope())
            {
                using (var horizontalScope = new GUILayout.HorizontalScope("box"))
                {
                    Helpers.Label("Spell Level:");
                    for (var i = 0; i < 10; i++)
                    {
                        if (menu == 2)
                        {
                            if (GUILayout.Button(i.ToString()))
                            {
                                PopulateAllKnownSpells();
                                allKnownSpellLevelMenu = i;
                            }
                        }
                        else
                        {
                            if (GUILayout.Button(i.ToString()))
                            {
                                readyForProfileSpellLevelMenu = i;
                            }
                        }
                    }
                }
            }
        }

        private static void PopulateAllKnownSpells()
        {
            foreach (var ac in Game.Instance.Player.AllCharacters.ToList())
            {
                foreach (var sb in ac.Descriptor.Spellbooks.ToList())
                {
                    foreach (var s in sb.GetAllKnownSpells().ToList())
                    {
                        if (allKnownSpells.FirstOrDefault(o => o.Name == s.Name) == null)
                        {
                            allKnownSpells.Add(s);
                        }
                    }
                }
            }
        }
    }
}